# https://community.home-assistant.io/t/sonos-tts-script/8896/62
sonos_tts:
  alias: Sonos Text To Speech
  sequence:
    - service: media_player.sonos_snapshot
      data_template:
        entity_id: "{{ 'media_player.' ~ where }}"
        with_group: yes
    - service: media_player.sonos_unjoin
      data_template:
        entity_id: "{{ 'media_player.' ~ where }}"
    - service: media_player.volume_set
      data_template:
        entity_id: "{{ 'media_player.' ~ where }}"
        volume_level: 0.40
    - service: tts.google_say
      data_template:
        entity_id: "{{ 'media_player.' ~ where }}"
        message: "{{ what }}"

    - wait_template: >-
        {{ is_state('media_player.' ~ where , 'playing') }}
      timeout: '00:00:5'

    - wait_template: >-
        {{ not is_state('media_player.' ~ where , 'playing') }}
      timeout: '00:00:05'

    - service: media_player.sonos_restore
      data_template:
        entity_id: "{{ 'media_player.' ~ where }}"
        with_group: yes

    - service: script.sonos_group_players
